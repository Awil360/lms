pipeline {
    agent any

    environment {
        // Define environment variables
        DOCKER_REGISTRY = 'awil360'
        frontend_IMAGE = 'awil360/lms-front'
        backend_IMAGE = 'awil360/lms-backenddd'
        DOCKER_CREDENTIALS_ID = 'lms-docker' 
        POSTGRES_CONTAINER_NAME = 'lms-db'
        POSTGRES_PASSWORD = 'awil123456'
        POSTGRES_IMAGE = 'postgres'


    }
        
    stages {

        stage('Start PostgreSQL Container') {
            steps {
                script {
                    // Run PostgreSQL container
                    sh """
                        docker run -dt --name ${env.POSTGRES_CONTAINER_NAME} \
                        -e POSTGRES_PASSWORD=${env.POSTGRES_PASSWORD} \
                        ${env.POSTGRES_IMAGE}
                    """
                }
            }
        }


        stage('Checkout') {
            steps {
                // Checkout the source code
                checkout scm
            }
        }

        stage('Read Version') {
            steps {
                script {
                    def packageJson = readFile('webapp/package.json')
                    def json = readJSON text: packageJson
                    env.VERSION = json.version
                    env.IMAGE_TAG = "${DOCKER_IMAGE}:${env.VERSION}"
                    env.BACKEND_IMAGE_TAG = "${BACKEND_IMAGE}:${env.VERSION}"
                }
            }
        }


         stage('Build Backend Docker Image') {
            steps {
                script {
                    docker.build(env.BACKEND_IMAGE_TAG, 'api') // Adjust the path to your backend Dockerfile if needed
                }
            }
        }

        stage('Push Backend Docker Image') {
            steps {
                script {
                    docker.withRegistry('', env.DOCKER_CREDENTIALS_ID) {
                        docker.image(env.BACKEND_IMAGE_TAG).push()
                    }
                }
            }
        }
        stage('Build frontend Docker Image') {
            steps {
                script {
                    docker.build(env.IMAGE_TAG, 'webapp')
                }
            }
        }

        stage('Push frontend Docker Image') {
            steps {
                script {
                    docker.withRegistry('', env.DOCKER_CREDENTIALS_ID) {
                        docker.image(env.IMAGE_TAG).push()
                    }
                }
            }
        }
    }
}
